# AITaskBot

## Оглавление
- [Назначение и возможности](#назначение-и-возможности)
- [Архитектура решения](#архитектура-решения)
- [Подготовка окружения и ключей](#подготовка-окружения-и-ключей)
- [Сборка](#сборка)
- [Установка и запуск](#установка-и-запуск)
- [Управление отправкой уведомлений и отчетов](#управление-отправкой-уведомлений-и-отчетов)
- [Логирование](#логирование)
- [Тестирование и контроль качества](#тестирование-и-контроль-качества)
- [Диагностика и типовые ошибки](#диагностика-и-типовые-ошибки)
- [Расширение и адаптация](#расширение-и-адаптация)

---

## Назначение и возможности
AITaskBot — консольное приложение на .NET 6, принимающее ежедневные отчеты сотрудников через Telegram и автоматически напоминающее об отсутствии отчетов. Бот сохраняет данные в локальную SQLite-базу, валидирует формат сообщений, уведомляет администраторов о новых отчетах и поддерживает ролевую модель доступа.

**Ключевые возможности:**
- прием структурированных отчетов с проверкой обязательных полей и ограничением частоты отправки;  
- уведомление администраторов о новых отчетах и хранение истории в `DailyReports.db`;  
- фоновый планировщик напоминаний с учетом часового пояса и личного расписания;  
- Telegram-команды для администрирования, получения статистики и управления отпусками;  
- встроенный справочник пользователей с ролями и индивидуальными настройками.

### Как бот обрабатывает отчеты и напоминания
- Проверяет, что пользователь зарегистрирован и не отправлял отчет меньше 24 часов назад.  
- Валидирует наличие блоков «Имя», «Дата», «Часов», «Сделано», «Проблемы» и «Планируется» и формат даты `ДД.ММ.ГГГГ`.  
- Сохраняет данные отчета в SQLite и информирует администраторов через личные сообщения.  
- Каждую минуту планировщик сверяет локальное время пользователя с дедлайном и отправляет напоминание, если отчет отсутствует.  
- Учитывает индивидуальный часовой пояс, выходные и временное отключение напоминаний через `/vacation`.

---

## Архитектура решения
Архитектура организована модульно. Каждый блок отвечает за конкретный аспект работы бота:

| Слой              | Компоненты                                                       | Ответственность                                                                 |
|-------------------|-------------------------------------------------------------------|----------------------------------------------------------------------------------|
| Входная точка     | `Program`                                                        | Инициализирует базу, регистрирует сервисы и запускает хост                       |
| Telegram-инфраструктура | `BotReceiverService`, `MessageUpdateHandler`, `CommandDispatcher` | Получение апдейтов, маршрутизация команд и передача текстов в обработчики        |
| Обработка отчетов | `ReportHandler`, `DatabaseHelper`, `DailyReport`                 | Валидация формата, сохранение в SQLite и уведомление администраторов             |
| Роли и пользователи | `Account`, `AccountProvider`, `DatabaseHelper`                 | Хранение ролей, дефолтных настроек и справочника пользователей                   |
| Администрирование | Команды `/add_*`, `/remove_user`, `/list`, `/stats`, `/help`     | Управление доступом, получение сводок и контекстной помощи                       |
| Планировщик       | `NotificationScheduler`, `VacationRegistry`                      | Периодическая проверка дедлайнов и учет отпусков                                 |
| Утилиты           | `DateRangeParser`, `HelpTextProvider`, `TelegramAPI`              | Парсинг дат, генерация справки и получение имен из Telegram                      |

---

## Подготовка окружения и ключей

### Предварительные требования
- .NET SDK 9.0 или выше (см. `global.json`).  
- Доступ к Telegram Bot API и токен бота.  
- Возможность писать в файловую систему для `DailyReports.db`.

### Конфигурация и секреты
1. Получите токен у @BotFather и задайте его в `AITaskBot/Telegram/TelegramAPI.cs` вместо значения по умолчанию.  
2. При необходимости заполните `AccountProvider.Accounts` актуальными пользователями и их настройками.  
3. Убедитесь, что у процесса есть права на создание и обновление `DailyReports.db` в корне приложения.

#### Telegram
1. Создайте бота через @BotFather и сохраните токен.  
2. Добавьте бота в рабочий чат или используйте личные сообщения для отчетов.  
3. Узнайте Telegram ID сотрудников (через специальные боты или API) и добавьте их в `AccountProvider`.

#### SQLite
1. Отдельная установка не требуется: база создается автоматически при первом запуске.  
2. Для миграции или резервного копирования достаточно сохранить файл `DailyReports.db`.

---

## Сборка
```bash
dotnet restore
dotnet build AITaskBot.sln -c Release
```

Публикация однофайловой сборки для Linux:
```bash
dotnet publish AITaskBot/AITaskBot.csproj \
  -c Release \
  -r linux-x64 \
  --self-contained true \
  -p:PublishSingleFile=true \
  -p:PublishReadyToRun=true \
  -p:InvariantGlobalization=true \
  -p:DebugType=None -p:DebugSymbols=false \
  -o ./publish/linux-x64
```

---

## Установка и запуск
### Локальный запуск
```bash
dotnet run --project AITaskBot/AITaskBot.csproj
```
База `DailyReports.db` будет создана рядом с исполняемым файлом.

### Развертывание на сервере
1. Соберите релизную версию и подготовьте артефакты публикации:
```bash
dotnet publish AITaskBot/AITaskBot.csproj -c Release -r linux-x64
```
2. Создайте на сервере структуру каталогов и выдайте права пользователю, под которым будет работать сервис. Пример для пользователя `deploy`:
```bash
ssh -t deploy@93.183.127.232 "sudo mkdir -p /opt/apps/ai_task_bot/out
sudo chown -R deploy:deploy /opt/apps/ai_task_bot
sudo chmod -R 755 /opt/apps/ai_task_bot"
```
3. Передайте собранные файлы и минимальную конфигурацию на сервер:
```bash
rsync -az --delete ./publish/linux-x64/ deploy@93.183.127.232:/opt/apps/ai_task_bot/out/
```
   При первом запуске `DailyReports.db` создается автоматически в каталоге запуска; при миграции существующую базу можно скопировать вместе с бинарем.
4. (Опционально) подготовьте файл окружения с настройками токена и путей. Пример минимального `.env.release` рядом с бинарем:
```bash
TELEGRAM__BOT_TOKEN=1234567890:ABCDEF
TELEGRAM__ADMIN_IDS=123456789,987654321
DATABASE__FILE=DailyReports.db
```
5. Создайте unit-файл `systemd`, чтобы бот стартовал автоматически. Сохраните конфигурацию в `/etc/systemd/system/aitaskbot.service`:
```bash
sudo nano /etc/systemd/system/ai_task_bot.service
```

```ini
[Unit]
Description=AITaskBot
After=network-online.target
Wants=network-online.target

[Service]
# Пользователь и группа под которыми будет работать бот
User=deploy
Group=deploy

# Рабочая директория
WorkingDirectory=/opt/apps/ai_task_bot/out/

# Основной исполняемый файл
ExecStart=/opt/apps/ai_task_bot/out/

# Файл окружения (.env.production)
EnvironmentFile=/opt/apps/ai_task_bot/out/.env.production

# Логирование
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ai_task_bot

# Автоматический рестарт при падении
Restart=always
RestartSec=5

# Таймауты и ограничения
TimeoutStartSec=30
TimeoutStopSec=15

[Install]
WantedBy=multi-user.target
```
6. Примените юнит и запустите сервис:
```bash
sudo systemctl daemon-reload
sudo systemctl enable aitaskbot
sudo systemctl restart aitaskbot
```
7. Проверьте, что файлы и права выставлены корректно, а бинарь доступен для запуска:
```bash
ls -la /opt/apps/aitaskbot/out
test -x /opt/apps/aitaskbot/out/AITaskBot && echo OK:exec
test -f /opt/apps/aitaskbot/out/.env.release && echo OK:env || echo WARN:no-env
test -d /opt/apps/aitaskbot/out && echo OK:dir
mkdir -p /opt/apps/aitaskbot/.cache && chown -R deploy:deploy /opt/apps/aitaskbot
```
8. Для диагностики состояния и логов используйте стандартные команды `systemd`:
```bash
sudo systemctl status aitaskbot
sudo journalctl -u aitaskbot -n 200 --no-pager
sudo journalctl -u aitaskbot -f
```
   При необходимости можно запустить бинарь вручную от пользователя `deploy` для локальной проверки:
```bash
sudo -u deploy env -i DOTNET_BUNDLE_EXTRACT_BASE_DIR=/opt/apps/aitaskbot/.cache \
  $(grep -v '^\s*$' /opt/apps/aitaskbot/out/.env.release | sed 's/^/ /') \
  /opt/apps/aitaskbot/out/AITaskBot
```

---

## Управление отправкой уведомлений и отчетов
- Текст без слеша обрабатывается как ежедневный отчет. Формат проверяется автоматически, ошибки возвращаются пользователю.  
- `/start` — инструкция по формату отчета.  
- `/help` — список доступных команд с учетом роли.  
- `/vacation DD.MM.YYYY` — отключение напоминаний до указанной даты включительно.  
- `/add_admin`, `/add_moderator`, `/add_user [ID]` — назначение ролей (только администратор).  
- `/remove_user [ID]` — удаление пользователя из базы (только администратор).  
- `/list` — список зарегистрированных аккаунтов (админ/модератор).  
- `/stats DD.MM.YYYY-DD.MM.YYYY` — суммарные часы по всем пользователям.  
- `/stats [ID] DD.MM.YYYY-DD.MM.YYYY` — подробности по конкретному сотруднику.

Фоновый планировщик проверяет состояние раз в минуту. Напоминания отправляются только в рабочие дни, после наступления индивидуального дедлайна и при отсутствии отчета за локальную дату пользователя.

---

## Логирование
- Все подсистемы пишут сообщения через облегчённый статический класс `TaskManager.Log`.
- Уровни логирования: Trace/Debug/Information/Warning/Error/Critical. Ошибки и критические события отправляются в stderr, остальные — в stdout.
- Минимальный уровень можно настроить через `Log.MinimumLevel` (по умолчанию: Trace в DEBUG, Information в RELEASE).
- Для интеграции с внешними системами мониторинга можно перенаправить stdout/stderr или заменить реализацию логгера.

---

## Тестирование и контроль качества
- Базовая проверка сборки: `dotnet build AITaskBot.sln`.  
- Локальная проверка: отправьте тестовый отчет с корректным и некорректным форматом, убедитесь в сохранении данных в SQLite.  
- Проверка напоминаний: временно установите дедлайн на ближайшие минуты и дождитесь уведомления.  
- Верификация команд: протестируйте `/help`, `/stats`, `/vacation` и административные команды с разными ролями.

---

## Диагностика и типовые ошибки
**Бот не отвечает**  
- Проверьте корректность токена в `TelegramAPI`.  
- Убедитесь, что бот добавлен в чат и имеет право читать сообщения.

**Не создается база или отчеты не сохраняются**  
- Проверьте права на запись в каталог запуска.  
- Убедитесь, что приложение не запущено из каталога только для чтения.

**Напоминания не приходят**  
- Убедитесь, что пользователю назначен корректный часовой пояс и время дедлайна.  
- Проверьте, не активирован ли отпуск через `/vacation`.

**Статистика пустая**  
- Убедитесь, что диапазон дат указан в формате `ДД.ММ.ГГГГ` и отчеты присутствуют в базе.  
- Проверьте, что используются корректные Telegram ID.

---

## Расширение и адаптация
- Добавление новых ролей: расширьте enum `Role` и соответствующие ветки в `HelpTextProvider`.  
- Изменение формата отчета: обновите проверки в `ReportHandler` и структуру `DailyReport`.  
- Подключение внешнего хранилища: замените `DatabaseHelper` на слой доступа к выбранной СУБД.  
- Новые команды: реализуйте `ICommand` и зарегистрируйте обработчик в `Program`.  
- Дополнительные каналы уведомлений: расширьте `NotificationScheduler` или внедрите новые фоновые службы.
